{% extends 'base.html' %}

{% block title %}Chat Page{% endblock %}

{% block content %}
    <div class="col-12 mx-auto full-screen-h">
        <div class="row full-screen-h">
            <!-- Sidebar for available chats -->
            <div class="col-md-4">
                <div class="card border-0 px-2 py-2" style="height: 100%">
                    <div class="card-body">
                        <h1>Chats</h1>
                        <div class="list-group list-group-flush scrollarea">
                            {% for chat in chats %}
                                <a href="#" class="list-group-item list-group-item-action py-3 lh-tight">
                                    <div class="d-flex w-100 align-items-center justify-content-between">
                                        <strong class="mb-1">{{ chat.name }}</strong>
                                        <small class="text-muted">{{ chat.last_updated }}</small>
                                    </div>
                                    <div class="col-10 mb-1 small">{{ chat.preview_message }}</div>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <!-- Main Content Area -->
            <div class="col-md-8">
                <div class="card border-0 px-2 py-2" style="height: 100%;">
                    <div class="card-body">
                        <h1>Chat Room - Name Placeholder</h1>
                        <hr>
                        <!-- Chat content will go here -->
                        <div id="chatWindow" class="px-3 py-3 fw-bolder chat-container"
                             style="max-height: 70vh; overflow-y: auto;">
                        </div>

                        <!-- Message Bar -->
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Type a message...">
                            <!-- Search Button -->
                            <button class="btn btn-primary">
                                Send
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const roomName = 'some_room_name';
        const currentUsername = '{{ user.username }}';
        const chatContainer = document.querySelector('.chat-container');

        // Fetch past messages
        fetch(`/chat/${roomName}/past_messages/`)
            .then(response => response.json())
            .then(data => {
                const messages = data.messages;
                for (let message_data of messages) {
                    addMessage(message_data.id, message_data.content, message_data.author, message_data.timestamp);
                }
            });

        // Create a WebSocket for the given room
        const chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/${roomName}/`);

        // When a message is received...
        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            addMessage(data.id, data.message, data.author, data.timestamp);
        };

        // When the socket is closed...
        chatSocket.onclose = function (e) {
            console.error('Chat socket closed unexpectedly');
        };

        // When a message is sent...
        document.addEventListener('click', async function (e) {
            if (e.target && e.target.classList.contains('btn-primary')) {
                const messageInput = document.querySelector('.form-control');
                const message = messageInput.value;

                // Register the message and get an ID
                const response = await fetch('/register_message/', {
                    method: 'POST',
                    body: JSON.stringify({message: message}),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                const message_id = data.message_id;

                // Send the message via WebSocket
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'message_id': message_id
                }));

                // Add the message to the chat window
                addMessage(message, currentUsername, 'just now', message_id);
                messageInput.value = '';
            }
        });

        const messageIds = new Set();  // To keep track of message IDs

        function addMessage(id, message, user, timestamp) {
            if (messageIds.has(id)) {
                return;  // Message already exists
            }
            messageIds.add(id);  // Add the new message ID

            let type = (currentUsername === user) ? "outgoing" : "incoming";
            chatContainer.insertAdjacentHTML('beforeend', `
                <div class="msg my-3 msg-${type}">
                    <small class="msg-author">${user}</small><br>
                    ${message}<br>
                    <small class="msg-timestamp">${convertToLocalTime(timestamp)}</small>
                </div>
            `);
        }

        function convertToLocalTime(isoTimestamp) {
            const date = new Date(isoTimestamp);
            const now = new Date();

            const isSameDay = date.getDate() === now.getDate() &&
                date.getMonth() === now.getMonth() &&
                date.getFullYear() === now.getFullYear();

            const isYesterday = date.getDate() === now.getDate() - 1 &&
                date.getMonth() === now.getMonth() &&
                date.getFullYear() === now.getFullYear();

            if (isSameDay) {
                const timeOptions = {hour: '2-digit', minute: '2-digit'};
                return date.toLocaleTimeString('en-US', timeOptions);
            }

            if (isYesterday) {
                const timeOptions = {hour: '2-digit', minute: '2-digit'};
                return `Yesterday at ${date.toLocaleTimeString('en-US', timeOptions)}`;
            }

            if (date.getFullYear() === now.getFullYear()) {
                const dateOptions = {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'};
                return date.toLocaleDateString('en-US', dateOptions);
            }

            const dateOptions = {year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'};
            return date.toLocaleDateString('en-US', dateOptions);
        }
    </script>
{% endblock %}

